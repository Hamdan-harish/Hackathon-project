<!DOCTYPE html>
<html>
<head>
<title>Analytics â€” SmartCampus Fix</title>

<style>
:root{
  --bg:#0B1220;--panel:#0F172A;--card:#101B33;--border:#1F2A44;
  --text:#E5E7EB;--muted:#94A3B8;
}
body{background:var(--bg);color:var(--text);font-family:Inter,Arial;margin:0}

.nav-right a.active{
  color:white;
  font-weight:600;
  border-bottom:2px solid #3B82F6;
  padding-bottom:3px;
}


.navbar{background:#0A1222;border-bottom:1px solid var(--border);
padding:14px 22px;display:flex;justify-content:space-between;align-items:center}
.nav-right a{color:var(--muted);margin-right:14px;text-decoration:none}
.nav-right a:hover{color:white}

.container{max-width:1050px;margin:26px auto;padding:0 14px}
.card{background:var(--card);border:1px solid var(--border);
border-radius:16px;padding:16px;margin-bottom:12px}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:800px){.grid-2{grid-template-columns:1fr}}
.note{color:var(--muted);font-size:13px}

/* fixed-height chart wrapper */
.chart-wrapper{
  width:100%;height:260px;position:relative;
}
.chart-wrapper canvas{
  width:100% !important;height:100% !important;display:block;
}
</style>
</head>

<body>

<!-- NAVBAR (unchanged UI) -->
<div class="navbar">
  <div class="nav-left">SmartCampus Fix</div>

  <div class="nav-right">
    <a href="index.html">Home</a>
    <a id="navComplaints" href="login.html">Complaints</a>
    <a id="navAdmin" href="login.html" style="display:none">Admin</a>
    <a id="navAnalytics" href="login.html" style="display:none">Analytics</a>
    <a id="navLogin" class="button" href="login.html">Login</a>
  </div>
</div>


<div class="container">
  <h2 id="status">Analytics Dashboard</h2>
  <p class="note" id="infoMsg">Live analytics â€” auto updatingâ€¦</p>

  <div class="grid-2">
    <div class="card">
      <span class="note">Status Distribution</span>
      <div class="chart-wrapper"><canvas id="chartStatus"></canvas></div>
    </div>

    <div class="card">
      <span class="note">Category Distribution</span>
      <div class="chart-wrapper"><canvas id="chartCategory"></canvas></div>
    </div>
  </div>

  <div class="card">
    <span class="note">Priority Distribution</span>
    <div class="chart-wrapper"><canvas id="chartPriority"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ðŸ” HARD admin-only protection (blocks students + logged-out users) -->
<script type="module" src="scripts/require-admin.js"></script>

<!-- ðŸ”„ Shared navbar (login toggle, no redirect glitches) -->
<script type="module" src="scripts/auth-navbar.js"></script>

<!-- ðŸ“Š Real-time analytics -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore,collection,onSnapshot }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* CONFIG */
const app=initializeApp({
 apiKey:"AIzaSyBT7No8i0VsEpDH-AJzj5UgAi6czE4ojOY",
 authDomain:"my-project-ace79.firebaseapp.com",
 projectId:"my-project-ace79"
});
const db=getFirestore(app);

const infoMsg=document.getElementById("infoMsg");

let chartStatusObj=null, chartCategoryObj=null, chartPriorityObj=null;

/* ðŸ” real-time Firestore stream */
onSnapshot(collection(db,"complaints"), snap=>{
  let status={submitted:0,"in-progress":0,resolved:0};
  let category={}, priority={};

  snap.forEach(d=>{
    const c=d.data()||{};
    if(c.status)   status[c.status]=(status[c.status]||0)+1;
    if(c.category) category[c.category]=(category[c.category]||0)+1;
    if(c.priority) priority[c.priority]=(priority[c.priority]||0)+1;
  });

  renderCharts(status,category,priority);
  infoMsg.innerText="Live analytics â€” updated automatically âœ”";
});

/* ðŸŽ¨ render / update charts */
function renderCharts(status,category,priority){

  const st=[status.submitted||0,status["in-progress"]||0,status.resolved||0];

  if(!chartStatusObj){
    chartStatusObj=new Chart(chartStatus,{
      type:"bar",
      data:{labels:["Submitted","In-Progress","Resolved"],datasets:[{data:st}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  } else { chartStatusObj.data.datasets[0].data=st; chartStatusObj.update(); }

  const cl=Object.keys(category), cv=Object.values(category);
  if(!chartCategoryObj){
    chartCategoryObj=new Chart(chartCategory,{
      type:"pie",
      data:{labels:cl,datasets:[{data:cv}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  } else { chartCategoryObj.data.labels=cl; chartCategoryObj.data.datasets[0].data=cv; chartCategoryObj.update(); }

  const pl=Object.keys(priority), pv=Object.values(priority);
  if(!chartPriorityObj){
    chartPriorityObj=new Chart(chartPriority,{
      type:"bar",
      data:{labels:pl,datasets:[{data:pv}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  } else { chartPriorityObj.data.labels=pl; chartPriorityObj.data.datasets[0].data=pv; chartPriorityObj.update(); }
}
</script>

</body>
</html>
