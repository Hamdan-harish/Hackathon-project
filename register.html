<!DOCTYPE html>
<html>
<head>
    <title>Register Complaint â€” SmartCampus Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Theme variables */
            --bg: #F1F5F9;
            --card: #FFFFFF;
            --border: #E2E8F0;
            --primary: #3B82F6;
            --primary-dark: #2563EB;
            --text-main: #0F172A;
            --text-body: #475569;
            --text-muted: #94A3B8;
            --success: #10B981;
            --danger: #EF4444;
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            background: var(--bg);
            color: var(--text-body);
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Header */
        .header-area {
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: var(--text-main);
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 15px;
        }

        /* Form Card */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            box-shadow: var(--shadow-lg);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        /* Inputs */
        .input-wrapper {
            position: relative;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            padding-right: 50px !important;
            background: #F8FAFC;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            box-sizing: border-box;
            transition: all 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Microphone Button */
        .mic-btn {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        textarea + .mic-btn {
            top: auto;
            bottom: 12px;
            transform: none;
        }

        .mic-btn:hover {
            background: #EFF6FF;
            color: var(--primary);
            transform: translateY(-50%) scale(1.1);
        }

        textarea + .mic-btn:hover {
            transform: scale(1.1);
        }

        .mic-active {
            background: #FEE2E2 !important;
            color: #EF4444 !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* File Upload */
        .file-upload-wrapper {
            position: relative;
            background: #F8FAFC;
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary);
            background: #EFF6FF;
        }

        input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        /* Preview Area */
        .preview-box {
            margin-top: 16px;
            display: none;
            padding: 8px;
            background: #F1F5F9;
            border-radius: 12px;
            text-align: center;
        }

        .preview-box img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Submit Button */
        button.submit-btn {
            width: 100%;
            margin-top: 10px;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s;
        }

        button.submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Status Messages */
        #msg {
            margin-top: 16px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .success {
            background: #DCFCE7;
            color: #166534;
            display: block !important;
        }

        .error {
            background: #FEE2E2;
            color: #991B1B;
            display: block !important;
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="header-area">
            <h2>New Complaint</h2>
            <div class="subtitle">Fill out the form below to report a campus issue.</div>
        </div>

        <div class="card">
            <form id="complaintForm">

                <div class="form-group">
                    <label>Your Name</label>
                    <div class="input-wrapper">
                        <input id="name" type="text" placeholder="e.g. John Doe" required>
                        <button type="button" id="micName" class="mic-btn" title="Speak Name">ðŸŽ¤</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Complaint Title</label>
                    <div class="input-wrapper">
                        <input id="title" type="text" placeholder="Short summary of the issue" required>
                        <button type="button" id="micTitle" class="mic-btn" title="Speak Title">ðŸŽ¤</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <div class="input-wrapper">
                        <input id="location" type="text" placeholder="Block / Room No / Area">
                        <button type="button" id="micLocation" class="mic-btn" title="Speak Location">ðŸŽ¤</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="category" required>
                        <option disabled selected value="">Select...</option>
                        <option>Electrical</option>
                        <option>Cleaning</option>
                        <option>Network</option>
                        <option>Plumbing</option>
                        <option>Maintenance</option>
                        <option>Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <div class="input-wrapper">
                        <textarea id="desc" placeholder="Please describe the details of the problem..." required></textarea>
                        <button type="button" id="micDesc" class="mic-btn" title="Speak Description">ðŸŽ¤</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Attach Photo (Optional)</label>
                    <div class="file-upload-wrapper">
                        <span class="upload-icon">ðŸ“·</span>
                        <span style="font-size:14px; color:var(--text-muted)">Tap to take photo or upload image</span>
                        <input type="file" id="complaintImage" accept="image/*" capture="environment">
                    </div>

                    <div class="preview-box" id="previewBox">
                        <img id="previewImg">
                    </div>
                </div>

                <button class="submit-btn">Submit Complaint</button>
            </form>

            <div id="msg"></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // Firebase Config
    const app = initializeApp({
        apiKey: "AIzaSyBT7No8i0VsEpDH-AJzj5UgAi6czE4ojOY",
        authDomain: "my-project-ace79.firebaseapp.com",
        projectId: "my-project-ace79"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);

    // AI API Key
    // TODO: Insert production key before deployment
    const GEMINI_API_KEY = "Paste_Your_Api_key"; 
    
    const form = document.getElementById("complaintForm");
    const msg = document.getElementById("msg");
    const imgInput = document.getElementById("complaintImage");
    const previewBox = document.getElementById("previewBox");
    const previewImg = document.getElementById("previewImg");

    // Image Preview Logic
    if(imgInput) {
        imgInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            previewImg.src = URL.createObjectURL(file);
            previewBox.style.display = "block";
        });
    }

    // Cloudinary Upload
    async function uploadToCloudinary(file) {
        const cloudName = "dbqhf4icp";
        const uploadPreset = "smartfix";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: "POST", body: formData
        });
        const data = await res.json();
        return data.secure_url || null;
    }

    // Voice Input Handler
    function setupVoiceInput(btnId, inputId) {
        const btn = document.getElementById(btnId);
        const input = document.getElementById(inputId);

        if (!btn || !input) return;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.warn("Voice input not supported");
            btn.style.display = "none";
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = true; // Show text while speaking
        recognition.maxAlternatives = 1;

        let initialValue = ""; 

        btn.addEventListener("click", (e) => {
            e.preventDefault(); 
            e.stopPropagation();
            
            if (btn.classList.contains("mic-active")) {
                recognition.stop();
            } else {
                document.querySelectorAll(".mic-btn").forEach(b => b.classList.remove("mic-active"));
                
                initialValue = input.value.trim(); 
                try {
                    recognition.start();
                } catch(err) {
                    console.log("Mic start error:", err);
                }
            }
        });

        recognition.onstart = () => {
            btn.classList.add("mic-active");
        };

        recognition.onend = () => {
            btn.classList.remove("mic-active");
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            const speechText = finalTranscript || interimTranscript;
            const spacer = (initialValue && speechText) ? " " : "";
            
            if (speechText) {
                input.value = initialValue + spacer + speechText;
            }
        };

        recognition.onerror = (event) => {
            console.error("Voice Error:", event.error);
            btn.classList.remove("mic-active");
            if(event.error === 'not-allowed') {
                alert("Please allow microphone access in browser settings.");
            }
        };
    }

    setupVoiceInput("micName", "name");
    setupVoiceInput("micTitle", "title");
    setupVoiceInput("micLocation", "location");
    setupVoiceInput("micDesc", "desc");


    // AI Priority Analysis
    async function analyzePriority(title, desc, category) {
        
        const models = [
            "gemini-3-flash-preview",
            "gemini-2.0-flash-exp",    
            "gemini-1.5-flash",       
            "gemini-pro"              
        ];

        const prompt = `
            Act as a strict Campus Facility Manager. 
            Complaint: ${category} - ${title} - ${desc}

            YOUR TASK:
            Classify the priority based on the logical rules below.

            HIGH PRIORITY (Urgent / Dangerous / Critical)
            - Immediate safety hazards (sparks, exposed wires, gas smell, fire risk).
            - Major utility failures (Total power outage in a block, no water supply).
            - Security risks (Broken main door lock, broken window).
            - Hygiene disasters (Overflowing sewage, hazardous waste).

            MEDIUM PRIORITY (Disruptive / Functional Failure)
            - Prevents work/study but is safe (Monitor/Projector broken, Internet/WiFi down).
            - Discomfort issues (AC/Fan not working, Water cooler empty/broken).
            - Plumbing issues (Clogged sink, leaking tap, low water pressure).
            - Elevator stuck (if no one is inside).

            LOW PRIORITY (Cosmetic / Minor Inconvenience)
            - Aesthetic issues (Peeling paint, dirty floor, cracked tile).
            - Minor annoyances (Squeaky door, one light bulb flickering, furniture scratch).
            - Suggestions or non-urgent requests.

            SPAM (Invalid)
            - Gibberish (e.g., "asdf"), offensive text, or irrelevant topics.

            OUTPUT FORMAT:
            Return ONLY one word: "High", "Medium", "Low", or "Spam".
        `;

        for (const model of models) {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(url, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        return data.candidates[0].content.parts[0].text.trim();
                    }
                }
            } catch (e) {
                console.warn(`Model check failed: ${model}`);
            }
        }
        throw new Error("Unable to connect to AI service.");
    }

    // Auth Listener
    onAuthStateChanged(auth, user => {
        if (!user) {
            msg.className = "msg error";
            msg.innerText = "Redirecting to login...";
            setTimeout(() => location.href = "login.html", 600);
        }
    });

    // Form Submission
    form.addEventListener("submit", async e => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) {
            msg.className = "msg error";
            return msg.innerText = "Please login first.";
        }

        const nameVal = document.getElementById("name").value.trim();
        const titleVal = document.getElementById("title").value.trim();
        const descVal = document.getElementById("desc").value.trim();
        const categoryVal = document.getElementById("category").value;
        const locationVal = document.getElementById("location").value.trim();

        if (!nameVal || !titleVal || !descVal || !categoryVal) {
            msg.className = "msg error";
            return msg.innerText = "Please complete all required fields.";
        }

        msg.style.display = "block";
        msg.className = "msg";
        msg.style.background = "#EFF6FF";
        msg.style.color = "#3B82F6";
        msg.innerHTML = "<b>Analyzing priority...</b>";

        try {
            const aiResult = await analyzePriority(titleVal, descVal, categoryVal);

            if (aiResult.includes("Spam")) {
                msg.className = "msg error";
                msg.innerHTML = "<b>Spam Detected</b><br>Request rejected.";
                return;
            }

            let imageUrl = null;
            if (imgInput.files[0]) {
                imageUrl = await uploadToCloudinary(imgInput.files[0]);
            }

            await addDoc(collection(db, "complaints"), {
                userId: user.uid,
                name: nameVal,
                title: titleVal,
                description: descVal,
                location: locationVal,
                category: categoryVal,
                priority: aiResult,
                status: "submitted",
                image: imageUrl,
                createdAt: serverTimestamp(),
                notes: [],
                votes: { up: 0, down: 0 },
                voters: {}
            });

            msg.className = "msg success";
            msg.innerText = `Submitted! Priority: ${aiResult}`;
            form.reset();
            previewBox.style.display = "none";

            setTimeout(() => window.location.href = "complaints.html", 2000);

        } catch (err) {
            console.error(err);
            msg.className = "msg error";
            msg.innerText = "Error: " + err.message;
        }
    });
</script>
</body>
</html>