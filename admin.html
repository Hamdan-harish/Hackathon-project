<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard â€” SmartCampus Fix</title>

<style>
:root{
  --bg:#0B1220;
  --panel:#0F172A;
  --card:#101B33;
  --border:#1F2A44;
  --blue:#3B82F6;
  --blue-dark:#2563EB;
  --green:#22C55E;
  --amber:#F59E0B;
  --red:#EF4444;
  --text:#E5E7EB;
  --muted:#94A3B8;
}

body{
  background:var(--bg);
  color:var(--text);
  font-family:Inter, Arial;
  margin:0;
}

/* NAVBAR */
.navbar{
  background:#0A1222;
  border-bottom:1px solid var(--border);
  padding:14px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
}
.nav-left{font-size:18px;font-weight:600}
.nav-right a{
  color:var(--muted);
  text-decoration:none;
  margin-right:14px;
}
.nav-right a:hover{color:white}
.nav-right button{
  background:var(--blue-dark);
  border:none;
  padding:8px 12px;
  border-radius:9px;
  color:white;
}

/* LAYOUT */
.container{max-width:1050px;margin:26px auto;padding:0 14px}
h3{margin-bottom:6px}

/* CARDS */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:18px;
  margin:0 auto 14px;
  max-width:850px;
}

/* FILTER BAR */
.filters{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:14px;
  max-width:850px;
  margin-left:auto;
  margin-right:auto;
}
select{
  background:#0A1326;
  border:1px solid #23324e;
  padding:8px 10px;
  color:white;
  border-radius:10px;
}

/* STATUS TAG */
.tag{
  padding:5px 10px;
  border-radius:10px;
  font-size:12px;
}
.subtle{color:var(--muted);font-size:13px}

.tag.submitted{background:#1E293B}
.tag.inp{background:#1E3A8A}
.tag.resolved{background:#065F46}

/* BUTTONS */
button.small{
  padding:7px 10px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  color:white;
}
.blue{background:var(--blue)}
.blue:hover{background:var(--blue-dark)}
.green{background:var(--green)}
.orange{background:var(--amber)}
.red{background:var(--red)}

/* NOTES */
.noteBox{margin-top:10px}
textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  background:#0A1326;
  border:1px solid #23324e;
  color:white;
}
.noteItem{
  background:#0F172A;
  border:1px solid var(--border);
  padding:7px 10px;
  border-radius:10px;
  margin-top:6px;
  font-size:13px;
}

/* TIMELINE */
.timeline{display:flex;gap:8px;margin-top:6px}
.step{
  padding:6px 10px;
  border-radius:10px;
  background:#1a2643;
  color:#9ca3af;
}
.active{background:var(--blue-dark);color:white}

@media(max-width:650px){
  .card{padding:14px}
}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-left">SmartCampus Fix</div>

  <div class="nav-right">
    <a href="index.html">Home</a>
    <a href="complaints.html">My Complaints</a>
    <a href="analytics.html">Analytics</a>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">

<h3>Admin Dashboard</h3>
<p id="statusMsg" class="subtle"></p>

<!-- FILTERS -->
<div class="filters">
  <select id="filterCategory">
    <option value="all">All Categories</option>
    <option>Electrical</option>
    <option>Cleaning</option>
    <option>Network</option>
    <option>Maintenance</option>
    <option>Other</option>
  </select>

  <select id="filterPriority">
    <option value="all">All Priorities</option>
    <option>Low</option>
    <option>Medium</option>
    <option>High</option>
  </select>

  <select id="filterStatus">
    <option value="all">All Status</option>
    <option value="submitted">Submitted</option>
    <option value="in-progress">In-Progress</option>
    <option value="resolved">Resolved</option>
  </select>
</div>

<div id="list"></div>

</div>

<script type="module">

/* ------------ FIREBASE IMPORTS ------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut }
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy,
  onSnapshot, doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ------------ CONFIG ------------ */
const app = initializeApp({
 apiKey:"AIzaSyBT7No8i0VsEpDH-AJzj5UgAi6czE4ojOY",
 authDomain:"my-project-ace79.firebaseapp.com",
 projectId:"my-project-ace79"
});

const auth = getAuth(app);
const db   = getFirestore(app);

const list = document.getElementById("list");
const statusMsg = document.getElementById("statusMsg");

const filterCategory = document.getElementById("filterCategory");
const filterPriority = document.getElementById("filterPriority");
const filterStatus   = document.getElementById("filterStatus");


/* ------------ ðŸ” ADMIN-ONLY PROTECTION ------------ */
onAuthStateChanged(auth, async user=>{
 if(!user){
   window.location.href="login.html";
   return;
 }

 const snap = await getDoc(doc(db,"users",user.uid));

 if(!snap.exists()){
   alert("User record missing");
   window.location.href="complaints.html";
   return;
 }

 const data = snap.data();

 if(data.role !== "admin"){
   alert("Access denied â€” Admins only");
   window.location.href="complaints.html";
   return;
 }

 statusMsg.innerText = "Logged in as Admin âœ”";
 loadComplaints();
});


/* ------------ LOAD COMPLAINTS ------------ */
function loadComplaints(){

 const q=query(collection(db,"complaints"), orderBy("createdAt","desc"));

 onSnapshot(q, snap=>{
  list.innerHTML="";

  snap.forEach(d=>{
    const c = d.data();

    if(
      (filterCategory.value==="all" || c.category===filterCategory.value) &&
      (filterPriority.value==="all" || c.priority===filterPriority.value) &&
      (filterStatus.value==="all"   || c.status===filterStatus.value)
    ){

      const notesHtml = (c.notes || [])
        .slice().reverse()
        .map(n=>`<div class="noteItem">${n}</div>`)
        .join("");

      list.innerHTML += `
      <div class="card">

        <h3>${c.title}</h3>
        <p>${c.description}</p>
        <p class="subtle">${c.location}</p>

        <p><b>User:</b> ${c.name}</p>
        <p><b>Category:</b> ${c.category} â€” <b>Priority:</b> ${c.priority}</p>

        <div class="timeline">
          <div class="step ${c.status!=="submitted"?"active":""}">Submitted</div>
          <div class="step ${c.status==="in-progress"||c.status==="resolved"?"active":""}">In-Progress</div>
          <div class="step ${c.status==="resolved"?"active":""}">Resolved</div>
        </div>

        <p>
          <span class="tag ${
            c.status==="resolved" ? "resolved" :
            c.status==="in-progress" ? "inp" : "submitted"
          }">${c.status}</span>
        </p>

        <button class="small orange" onclick="updateStatus('${d.id}','in-progress')">Mark In-Progress</button>
        <button class="small green" onclick="updateStatus('${d.id}','resolved')">Mark Resolved</button>

        <div class="noteBox">
          <p><b>Work Updates</b></p>
          <textarea id="note_${d.id}" placeholder="Add progress noteâ€¦"></textarea>
          <button class="small blue" onclick="addNote('${d.id}')">Add Note</button>
          ${notesHtml || "<p class='subtle'>No updates yet</p>"}
        </div>

      </div>`;
    }
  });
 });
}

/* Filters refresh */
filterCategory.onchange =
filterPriority.onchange =
filterStatus.onchange = loadComplaints;


/* ------------ UPDATE STATUS ------------ */
window.updateStatus = async (id,status)=>{
 await updateDoc(doc(db,"complaints",id),{status});
 alert("Status updated âœ”");
};


/* ------------ ADD NOTE ------------ */
window.addNote = async (id)=>{
 const box = document.getElementById(`note_${id}`);
 const text = box.value.trim();
 if(!text) return;

 const ref = doc(db,"complaints",id);
 const snap = await getDoc(ref);
 const data = snap.data();

 const notes = data.notes || [];
 notes.push(text);

 await updateDoc(ref,{notes});
 box.value="";
 alert("Note added âœ”");
};


/* ------------ LOGOUT ------------ */
document.getElementById("logoutBtn").onclick = ()=>signOut(auth);
</script>

</body>
</html>
